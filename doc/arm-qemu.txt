Ananas/arm in emulator

We use QEMU with a VersatilePB board; this is all documented in [1]

1) Get CodeSourcery ARM toolchain

The Ananas toolchain isn't mature enough to build the u-boot loader, so we'll
use CodeSourcery's toolchain for now - available at [2]

Install in /opt/Sourcery_CodeBench_Lite_for_ARM_EABI

2) Build U-Boot

Note: we need to patch it before it will work [3]:

$ vi include/configs/versatile.h

Add '#define CONFIG_ARCH_VERSATILE_QEMU' after '#define __CONFIG_H'
Also add' #define CONFIG_OF_LIBFDT 1' after '#define CONFIG_CMDLINE_TAG'

$ git clone git://git.denx.de/u-boot.git
$ make ARCH=arm CROSS_COMPILE=arm-none-eabi- versatilepb_config    
$ make ARCH=arm CROSS_COMPILE=arm-none-eabi-

3) Build Ananas

Building the ARM kernel should work, but it'll need to be prepared for u-boot. We'll just concatenate the raw image behind the u-boot binary and then figure out where it is in memory, as inspired by [4]

$ arm-elf-ananas-objcopy -S -O binary kernel kernel.bin
$ mkimage -A arm -T kernel -a 0x00900000 -n Ananas/sheevaplug -C none -d kernel.bin ananas.ub
$ cat u-boot.bin ananas.ub > image.ub

4) Launch it

$ qemu-system-arm -M versatilepb -m 128M -nographic -kernel image.ub

Now it is time to boot Ananas, but we need to calculate the address of the image to do so. u-boot is linked to 0x10000, so the address of our image is at 0x10000 + sizeof(u-boot.bin). For example, if u-boot.bin is 112152 bytes, the address is 0x2b618

We can verify this by issuing 'iminfo 0x2b618', which should give something like:

## Checking Image at 0002b618 ...
   Legacy image found
   Image Name:   Ananas/sheevaplug
   Image Type:   ARM Linux Kernel Image (uncompressed)
   Data Size:    110592 Bytes = 108 KiB
   Load Address: 00900000
   Entry Point:  00900000
   Verifying Checksum ... OK

Finally, we can launch it by doimg 'bootm 0x2b618'.

[1] http://elinux.org/Virtual_Development_Board
[2] http://www.codesourcery.com/sgpp/lite/arm/portal/subscription?@template=lite)
[3] http://rechtzeit.wordpress.com/tag/u-boot-qemu-fatal-error/
[4] http://balau82.wordpress.com/2010/03/10/u-boot-for-arm-on-qemu/
