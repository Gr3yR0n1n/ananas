OBJS=		vfstest.o kernel-glue.o vfs.o vfs-generic.o vfs-icache.o vfs-dentry.o \
		bio.o device-glue.o ext2fs.o devfs.o
# cflags for our wrapper code
WCFLAGS=	-std=c99 -I.
# cflags for kernel stuff
KCFLAGS=	$(WCFLAGS) -I../../include
ARCH?=		amd64
K?=		../../kernel

GENEXT2FS?=	genext2fs 

target:		test

test:		vfstest image.ext2
		./vfstest image.ext2

vfstest:	machine $(OBJS)
		$(CC) -o vfstest $(OBJS)

vfstest.o:	vfstest.c
		$(CC) $(KCFLAGS) -c -o vfstest.o vfstest.c

kernel-glue.o:	ananas kernel-glue.c
		$(CC) $(WCFLAGS) -c -o kernel-glue.o kernel-glue.c

device-glue.o:	ananas device-glue.c
		$(CC) $(WCFLAGS) -c -o device-glue.o device-glue.c

# files normally generated by config
options.h:	Makefile
		echo '#define EXT2FS' > options.h
		echo '#define DEVFS' >> options.h

# kernel files below here
vfs.o:		$K/vfs/vfs.c ananas options.h
		$(CC) $(KCFLAGS) -c -o vfs.o $K/vfs/vfs.c

vfs-generic.o:	$K/vfs/vfs-generic.c
		$(CC) $(KCFLAGS) -c -o vfs-generic.o $K/vfs/vfs-generic.c

vfs-icache.o:	$K/vfs/vfs-icache.c
		$(CC) $(KCFLAGS) -c -o vfs-icache.o $K/vfs/vfs-icache.c

vfs-dentry.o:	$K/vfs/vfs-dentry.c
		$(CC) $(KCFLAGS) -c -o vfs-dentry.o $K/vfs/vfs-dentry.c

bio.o:		$K/kern/bio.c
		$(CC) $(KCFLAGS) -c -o bio.o $K/kern/bio.c

ext2fs.o:	$K/fs/ext2fs.c
		$(CC) $(KCFLAGS) -c -o ext2fs.o $K/fs/ext2fs.c

devfs.o:	$K/fs/devfs.c
		$(CC) $(KCFLAGS) -c -o devfs.o $K/fs/devfs.c


machine:
		ln -sf ../../include/ananas/${ARCH} machine

ananas:
		ln -sf ../../include/ananas

image.ext2:	vfstest
		mkdir -p image
		mkdir -p image/dev
		cp vfstest image
		${GENEXT2FS} -b 1024 -d image image.ext2
		rm -rf image

clean:
		rm -f vfstest machine ananas options.h image.ext2 $(OBJS)
