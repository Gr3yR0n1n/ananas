OBJS=		vfstest.o kernel-glue.o core.o generic.o icache.o dentry.o \
		standard.o mount.o bio.o device-glue.o ext2fs.o devfs.o
# general cflags
CFLAGS=		-g
# cflags for our wrapper code
WCFLAGS=	-std=c99 -I. $(CFLAGS)
# cflags for kernel stuff
KCFLAGS=	$(WCFLAGS) -I../../include $(CFLAGS)
ARCH?=		amd64
K?=		../../kernel

GENEXT2FS?=	genext2fs 

target:		test

test:		vfstest image.ext2
		./vfstest image.ext2

vfstest:	machine $(OBJS)
		$(CC) -o vfstest $(OBJS)

vfstest.o:	vfstest.c
		$(CC) $(KCFLAGS) -c -o vfstest.o vfstest.c

kernel-glue.o:	ananas kernel-glue.c
		$(CC) $(WCFLAGS) -c -o kernel-glue.o kernel-glue.c

device-glue.o:	ananas device-glue.c
		$(CC) $(WCFLAGS) -c -o device-glue.o device-glue.c

# files normally generated by config
options.h:	Makefile
		echo '#define EXT2FS' > options.h
		echo '#define DEVFS' >> options.h

# kernel files below here
core.o:		$K/vfs/core.c ananas options.h
		$(CC) $(KCFLAGS) -c -o core.o $K/vfs/core.c

generic.o:	$K/vfs/generic.c
		$(CC) $(KCFLAGS) -c -o generic.o $K/vfs/generic.c

icache.o:	$K/vfs/icache.c
		$(CC) $(KCFLAGS) -c -o icache.o $K/vfs/icache.c

dentry.o:	$K/vfs/dentry.c
		$(CC) $(KCFLAGS) -c -o dentry.o $K/vfs/dentry.c

standard.o:	$K/vfs/standard.c
		$(CC) $(KCFLAGS) -c -o standard.o $K/vfs/standard.c

mount.o:	$K/vfs/mount.c
		$(CC) $(KCFLAGS) -c -o mount.o $K/vfs/mount.c


bio.o:		$K/kern/bio.c
		$(CC) $(KCFLAGS) -c -o bio.o $K/kern/bio.c

ext2fs.o:	$K/fs/ext2fs.c
		$(CC) $(KCFLAGS) -c -o ext2fs.o $K/fs/ext2fs.c

devfs.o:	$K/fs/devfs.c
		$(CC) $(KCFLAGS) -c -o devfs.o $K/fs/devfs.c


machine:
		ln -sf ../../include/ananas/${ARCH} machine

ananas:
		ln -sf ../../include/ananas

image.ext2:	vfstest
		mkdir -p image
		mkdir -p image/dev
		cp vfstest image
		@for i in 0 1 2 3 4 5 6 7 8 9; do \
			for j in 0 1 2 3 4 5 6 7 8 9; do \
				touch image/$$i$$j;\
		done; done;
		${GENEXT2FS} -b 1024 -d image image.ext2
		rm -rf image

clean:
		rm -f vfstest machine ananas options.h image.ext2 $(OBJS)
